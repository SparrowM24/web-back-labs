{% extends "base.html" %}

{% block lab %}–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 9{% endblock %}

{% block main %}
    <h1>üéÑ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ü–æ–¥–∞—Ä–∫–∏ üéÅ</h1>
    
    <div class="info-panel">
        <p>–û—Ç–∫—Ä—ã—Ç–æ –∫–æ—Ä–æ–±–æ–∫: <span id="opened-count">0</span> –∏–∑ 3</p>
        <p>–û—Å—Ç–∞–ª–æ—Å—å –Ω–µ–æ—Ç–∫—Ä—ã—Ç—ã—Ö: <span id="remaining">10</span></p>
        <button id="reset-btn" class="reset-btn">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
    </div>
    
    <div id="boxes-container" class="boxes-container">
        <!-- –ö–æ—Ä–æ–±–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
    </div>
    
    <div id="message" class="message-container" style="display: none;">
        <div class="message-content">
            <button onclick="closeMessage()" class="close-btn">√ó</button>
            <h2>üéâ –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ! üéâ</h2>
            <p id="congrat-text"></p>
            <div id="gift-display" style="margin: 20px auto; text-align: center;">
                <img id="gift-image" src="" alt="–ü–æ–¥–∞—Ä–æ–∫" style="max-width: 200px; max-height: 200px; display: none;">
            </div>
        </div>
    </div>
    
    <style>
        body {
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            color: white;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            font-family: 'Arial', sans-serif;
            overflow-x: hidden;
        }
        
        h1 {
            text-align: center;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-size: 2.5em;
            margin-bottom: 30px;
        }
        
        .info-panel {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px auto;
            max-width: 500px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid #FFD700;
        }
        
        .info-panel p {
            font-size: 1.2em;
            margin: 10px 0;
        }
        
        .reset-btn {
            background: #FFD700;
            color: #1a2980;
            border: none;
            padding: 10px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 10px;
            font-weight: bold;
            transition: transform 0.3s;
        }
        
        .reset-btn:hover {
            transform: scale(1.05);
            background: #ffed4e;
        }
        
        .boxes-container {
            position: relative;
            width: 100%;
            height: 70vh;
            min-height: 500px;
            margin: 30px auto;
            border: 3px dashed #FFD700;
            border-radius: 15px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .gift-box {
            position: absolute;
            width: 100px;
            height: 100px;
            background: linear-gradient(45deg, #e2942d, #ffeb3b);
            border: 3px solid #c62828;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s;
            transform-origin: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            background-size: cover;
            overflow: hidden;
        }
        
        .gift-box-image {
            width: 70px;
            height: 70px;
            object-fit: contain;
            transition: transform 0.3s;
        }
        
        .gift-box:hover:not(.opened) {
            transform: scale(1.2) rotate(5deg);
            box-shadow: 0 0 20px gold;
            z-index: 10;
        }
        
        .gift-box:hover:not(.opened) .gift-box-image {
            transform: scale(1.1);
        }
        
        .gift-box.opened {
            background: linear-gradient(45deg, #78909c, #b0bec5);
            cursor: default;
            opacity: 0.7;
        }
        
        .gift-box.opened .gift-box-image {
            filter: grayscale(80%) brightness(70%);
        }
        
        .message-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
            z-index: 1000;
            min-width: 400px;
            max-width: 600px;
            border: 3px solid #FFD700;
            color: white;
        }
        
        .message-content {
            text-align: center;
        }
        
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            line-height: 1;
        }
        
        .close-btn:hover {
            color: #FFD700;
        }
        
        /* –°–Ω–µ–∂–∏–Ω–∫–∏ */
        .snowflake {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0.8;
            animation: fall linear infinite;
        }
        
        @keyframes fall {
            to {
                transform: translateY(100vh);
            }
        }
        
        #gift-image {
            border-radius: 10px;
            border: 3px solid #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            padding: 10px;
            background: white;
        }
    </style>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('boxes-container');
            const messageDiv = document.getElementById('message');
            const giftImage = document.getElementById('gift-image');
            const congratText = document.getElementById('congrat-text');
            const openedCountSpan = document.getElementById('opened-count');
            const remainingSpan = document.getElementById('remaining');
            const resetBtn = document.getElementById('reset-btn');
            
            // –°–æ–∑–¥–∞–µ–º —Å–Ω–µ–∂–∏–Ω–∫–∏
            createSnowflakes();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–æ–±–∫–∏
            function loadBoxes() {
                fetch('/lab9/get_boxes')
                    .then(response => response.json())
                    .then(data => {
                        container.innerHTML = '';
                        data.boxes.forEach(box => {
                            const boxDiv = document.createElement('div');
                            boxDiv.className = 'gift-box' + (box.opened ? ' opened' : '');
                            boxDiv.style.top = box.top + '%';
                            boxDiv.style.left = box.left + '%';
                            boxDiv.dataset.id = box.id;
                            boxDiv.dataset.congrat = box.congrat;
                            boxDiv.dataset.gift = box.gift_image;  // –ø—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –ø–æ–¥–∞—Ä–∫–∞
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∞
                            const giftImg = document.createElement('img');
                            giftImg.src = box.gift_image;  // –∏—Å–ø–æ–ª—å–∑—É–µ–º –¢–û –ñ–ï –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á—Ç–æ –∏ –¥–ª—è –ø–æ–¥–∞—Ä–∫–∞
                            giftImg.alt = '–ü–æ–¥–∞—Ä–æ–∫';
                            giftImg.className = 'gift-box-image';
                            
                            // –£–º–µ–Ω—å—à–∞–µ–º –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–ª—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–æ—Ä–æ–±–æ–∫
                            if (box.opened) {
                                giftImg.style.opacity = '0.5';
                            }
                            
                            boxDiv.appendChild(giftImg);
                            
                            if (!box.opened) {
                                boxDiv.addEventListener('click', openBox);
                            }
                            
                            container.appendChild(boxDiv);
                        });
                        
                        openedCountSpan.textContent = data.opened_count;
                        remainingSpan.textContent = data.remaining;
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—Ä–æ–±–æ–∫:', error);
                        showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—Ä–æ–±–æ–∫', true);
                    });
            }
            
            // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–æ—Ä–æ–±–∫–∏
            function openBox(event) {
                const boxId = event.currentTarget.dataset.id;
                const congrat = event.currentTarget.dataset.congrat;
                const gift = event.currentTarget.dataset.gift;
                
                fetch(`/lab9/open_box/${boxId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showMessage(data.error, true);
                    } else {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Ç–æ—Ç –∂–µ —Å–∞–º—ã–π –ø–æ–¥–∞—Ä–æ–∫ –≤ –±–æ–ª—å—à–µ–º —Ä–∞–∑–º–µ—Ä–µ
                        congratText.textContent = congrat;
                        giftImage.src = gift;
                        giftImage.style.display = 'block';
                        messageDiv.style.display = 'block';
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                        openedCountSpan.textContent = data.opened_count;
                        remainingSpan.textContent = data.remaining;
                        
                        // –ü–æ–º–µ—á–∞–µ–º –∫–æ—Ä–æ–±–∫—É –∫–∞–∫ –æ—Ç–∫—Ä—ã—Ç—É—é
                        const boxDiv = event.currentTarget;
                        boxDiv.classList.add('opened');
                        
                        // –î–µ–ª–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–ª–µ–¥–Ω—ã–º
                        const giftImg = boxDiv.querySelector('img');
                        if (giftImg) {
                            giftImg.style.opacity = '0.5';
                        }
                        
                        boxDiv.removeEventListener('click', openBox);
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–æ—Ä–æ–±–∫–∏:', error);
                    showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∫–æ—Ä–æ–±–∫–∏', true);
                });
            }
            
            // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            function showMessage(text, isError) {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'message ' + (isError ? 'error' : 'success');
                msgDiv.textContent = text;
                msgDiv.style.position = 'fixed';
                msgDiv.style.top = '20px';
                msgDiv.style.right = '20px';
                msgDiv.style.padding = '10px 20px';
                msgDiv.style.borderRadius = '5px';
                msgDiv.style.color = 'white';
                msgDiv.style.zIndex = '1000';
                msgDiv.style.backgroundColor = isError ? '#ff4444' : '#44ff44';
                msgDiv.style.boxShadow = '0 2px 10px rgba(0,0,0,0.3)';
                
                document.body.appendChild(msgDiv);
                
                setTimeout(() => {
                    if (msgDiv.parentNode) {
                        msgDiv.remove();
                    }
                }, 3000);
            }
            
            // –°–∫—Ä—ã—Ç–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø–æ–¥–∞—Ä–∫–µ
            window.closeMessage = function() {
                messageDiv.style.display = 'none';
                giftImage.style.display = 'none';
            }
            
            // –°–±—Ä–æ—Å
            resetBtn.addEventListener('click', function() {
                fetch('/lab9/reset', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadBoxes();
                        closeMessage();
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞:', error);
                    showMessage('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞', true);
                });
            });
            
            // –°–æ–∑–¥–∞–Ω–∏–µ —Å–Ω–µ–∂–∏–Ω–æ–∫
            function createSnowflakes() {
                const container = document.querySelector('body');
                for (let i = 0; i < 50; i++) {
                    const snowflake = document.createElement('div');
                    snowflake.className = 'snowflake';
                    const size = Math.random() * 10 + 5;
                    snowflake.style.width = size + 'px';
                    snowflake.style.height = size + 'px';
                    snowflake.style.left = Math.random() * 100 + 'vw';
                    snowflake.style.opacity = Math.random() * 0.5 + 0.3;
                    snowflake.style.animationDuration = Math.random() * 5 + 5 + 's';
                    snowflake.style.animationDelay = Math.random() * 5 + 's';
                    container.appendChild(snowflake);
                }
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–æ–±–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            loadBoxes();
        });
    </script>
{% endblock %}